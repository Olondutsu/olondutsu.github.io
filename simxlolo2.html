<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Jeu Arcade</title>
  <style>
    body {
      margin: 0;
      background-color: black;
      display: flex;
      height: 100vh;
      justify-content: center;
      align-items: center;
      font-family: 'Courier New', monospace;
      color: white;
      overflow: hidden;
    }
    .game-container {
      display: flex;
      gap: 30px;
      align-items: center;
    }
    .grid-container {
      background: #111;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 20px #f0f;
    }
    .game-grid {
      display: grid;
      grid-template-columns: repeat(4,80px);
      grid-template-rows: repeat(4,80px);
      gap: 4px;
    }
    .cell {
      width: 80px; height: 80px;
      background: #222;
      border-radius: 6px;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
    }
    .sprite {
      width: 60px; height: 60px;
      object-fit: contain;
      pointer-events: none;
    }
    .right-panel {
      text-align: center;
    }
    .countdown {
      font-size: 4em;
      color: yellow;
      text-shadow: 2px 2px red;
    }
    .score {
      font-size: 1.5em;
      color: #0f0;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="game-container">
    <div class="grid-container">
      <div class="game-grid" id="grid"></div>
      <div class="score">Score: <span id="score">0</span></div>
    </div>
    <div class="right-panel">
      <div class="countdown" id="countdown">00:000</div>
    </div>
  </div>

  <audio id="pickupSound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_c08e731e3e.mp3"></audio>
  <audio id="bgm" src="https://cdn.pixabay.com/audio/2023/02/21/audio_d9c75e6dfb.mp3" loop></audio>

<script>
const ROWS=4, COLS=4, MAX_COINS=5;
const SPRITES={player:"images/player_default.png",coin1:"images/coin1.png",coin3:"images/coin3.png"};
const PROBABILITIES=[{value:1,prob:0.7,duration:4000},{value:3,prob:0.3,duration:2500}];

const gridEl=document.getElementById('grid');
const scoreEl=document.getElementById('score');
const countdownEl=document.getElementById('countdown');
const pickup = document.getElementById('pickupSound');
const bgm = document.getElementById('bgm');
bgm.volume = 0.4;
bgm.play().catch(()=>{});

let board=[],score=0,isRunning=false;

function createGrid(){
  board=[];
  gridEl.innerHTML='';
  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      const cell=document.createElement('div');
      cell.className='cell';
      board.push({r,c,el:cell,value:0});
      gridEl.appendChild(cell);
    }
  }
}

function startCountdown(ms){
  const start=Date.now();
  const iv=setInterval(()=>{
    const rem = Math.max(ms - (Date.now()-start),0);
    const s = String(Math.floor(rem/1000)).padStart(2,'0');
    const m = String(rem%1000).padStart(3,'0');
    countdownEl.textContent = `${s}:${m}`;
    if(rem<=0){ clearInterval(iv); countdownEl.textContent='00:000'; }
  },33);
}

function spawnCoin(){
  if(document.hidden) return;
  const cnt = board.filter(b=>b.value>0).length;
  if(cnt>=MAX_COINS) return;
  const empties = board.filter(b=>b.value===0);
  if(!empties.length) return;
  const t=empties[Math.floor(Math.random()*empties.length)];
  let rand=Math.random(),ch=PROBABILITIES.find(p=> (rand-=p.prob)<0 );
  if(!ch) ch=PROBABILITIES[0];
  t.value=ch.value;
  const img=new Image();
  img.src=SPRITES[`coin${ch.value}`];
  img.className='sprite';
  t.el.innerHTML=''; t.el.appendChild(img);
  setTimeout(()=>{
    if(t.value===ch.value){ t.value=0; t.el.innerHTML=''; }
  },ch.duration);
}

function run(dir,idx,speedLev){
  if(isRunning) return;
  isRunning=true;
  const speed=6+speedLev*2;
  const delay=1000/speed;
  const steps=(dir==='row'?COLS:ROWS);
  let i=0,gained=0;
  startCountdown(steps*delay+200);
  const iv=setInterval(()=>{
    if(i>=steps){ clearInterval(iv); isRunning=false; return; }
    const br=dir==='row'? board[idx*COLS + i] : board[i*COLS + idx];
    if(br.value>0){
      score+=br.value; gained+=br.value;
      pickup.currentTime=0; pickup.play();
      br.value=0;
    }
    board.forEach(b=>{if(b.value===0){b.el.innerHTML='';}});
    const img=new Image(); img.src=SPRITES.player; img.className='sprite';
    br.el.innerHTML=''; br.el.appendChild(img);
    i++;
  },delay);
  setTimeout(()=>{
    scoreEl.textContent=score;
  }, steps*delay);
}

createGrid();
gridEl.parentElement.addEventListener('click', e=>{
  if(isRunning) return;
  const cells = [...document.querySelectorAll('.cell')];
  if(cells.includes(e.target.closest('.cell'))) return;
});
for(const idx of board.keys()){ /* noop to define */
}
createGrid();
document.querySelector('.grid-container').addEventListener('click', e=>{
  if(isRunning) return;
  // detect selector virtual: top row or left column click => rare in new layout
});
gridEl.parentElement.addEventListener('keydown',()=>{}); // placeholder
document.body.addEventListener('click',e=>{
  if(isRunning) return;
});
gridEl.addEventListener('click',e=>{
  if(isRunning) return;
});
for(let r=0;r<ROWS;r++){
  for(let c=0;c<COLS;c++){
    const pos=r*COLS+c;
    board[pos].el.addEventListener('click',()=>{
      run('row', r, (c%3)+1 );
    });
  }
}
setInterval(spawnCoin, 800);

</script>
</body>
</html>
