<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Arcade Mode</title>
  <style>
    html, body {
      margin: 0;
      height: 100%;
      background: black;
      color: white;
      font-family: monospace;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    .container {
      display: flex;
      gap: 40px;
      align-items: center;
    }
    .game {
      display: grid;
      grid-template-columns: repeat(4, 80px);
      grid-template-rows: repeat(4, 80px);
      gap: 4px;
      background: #111;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 20px #f0f;
    }
    .cell {
      width: 80px;
      height: 80px;
      background: #222;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      position: relative;
    }
    .sprite {
      width: 60px;
      height: 60px;
      object-fit: contain;
      pointer-events: none;
    }
    .side-panel {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .countdown {
      font-size: 4em;
      text-shadow: 2px 2px red;
      color: yellow;
    }
    .score {
      margin-top: 20px;
      font-size: 1.5em;
      color: lime;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="game" id="grid"></div>
    <div class="side-panel">
      <div class="countdown" id="countdown">00:000</div>
      <div class="score">Score: <span id="score">0</span></div>
    </div>
  </div>

  <audio id="pickupSound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_c08e731e3e.mp3"></audio>
  <audio id="bgm" src="https://cdn.pixabay.com/audio/2023/02/21/audio_d9c75e6dfb.mp3" loop></audio>

  <script>
    const ROWS = 4, COLS = 4, MAX_COINS = 5;
    const SPRITES = {
      player: "images/player_default.png",
      coin1: "images/coin1.png",
      coin3: "images/coin3.png"
    };
    const COINS = [
      { value: 1, prob: 0.7, duration: 3000 },
      { value: 3, prob: 0.3, duration: 1800 }
    ];

    const gridEl = document.getElementById('grid');
    const scoreEl = document.getElementById('score');
    const countdownEl = document.getElementById('countdown');
    const pickupSound = document.getElementById('pickupSound');
    const bgm = document.getElementById('bgm');
    bgm.volume = 0.3;
    bgm.play().catch(() => {});

    let grid = [], score = 0, isRunning = false;

    function createGrid() {
      grid = [];
      gridEl.innerHTML = "";
      for (let r = 0; r < ROWS; r++) {
        for (let c = 0; c < COLS; c++) {
          const cell = document.createElement('div');
          cell.className = 'cell';
          grid.push({ r, c, el: cell, value: 0 });
          gridEl.appendChild(cell);
        }
      }
    }

    function formatTime(ms) {
      const s = String(Math.floor(ms / 1000)).padStart(2, '0');
      const m = String(ms % 1000).padStart(3, '0').slice(0, 3);
      return `${s}:${m}`;
    }

    function startCountdown(ms) {
      const start = Date.now();
      const interval = setInterval(() => {
        const rem = Math.max(ms - (Date.now() - start), 0);
        countdownEl.textContent = formatTime(rem);
        if (rem <= 0) {
          clearInterval(interval);
          countdownEl.textContent = "00:000";
        }
      }, 33);
    }

    function spawnCoin() {
      if (document.hidden) return;
      if (grid.filter(g => g.value > 0).length >= MAX_COINS) return;

      const empty = grid.filter(g => g.value === 0);
      if (empty.length === 0) return;

      const spot = empty[Math.floor(Math.random() * empty.length)];
      let rand = Math.random();
      let choice = COINS.find(c => (rand -= c.prob) < 0) || COINS[0];

      spot.value = choice.value;
      const img = new Image();
      img.src = SPRITES[`coin${choice.value}`];
      img.className = "sprite";
      spot.el.innerHTML = '';
      spot.el.appendChild(img);

      setTimeout(() => {
        if (spot.value === choice.value) {
          spot.value = 0;
          spot.el.innerHTML = '';
        }
      }, choice.duration);
    }

    function run(type, index) {
      if (isRunning) return;
      isRunning = true;

      const speed = 8;
      const delay = 1000 / speed;
      const steps = (type === "row") ? COLS : ROWS;
      let i = 0;

      let gain = 0;
      startCountdown(steps * delay + 200);

      const interval = setInterval(() => {
        if (i >= steps) {
          clearInterval(interval);
          score += gain;
          scoreEl.textContent = score.toFixed(0);
          isRunning = false;
          return;
        }

        const cell = (type === "row") ?
          grid[index * COLS + i] :
          grid[i * COLS + index];

        if (cell.value > 0) {
          gain += cell.value;
          pickupSound.currentTime = 0;
          pickupSound.play();
        }

        cell.value = 0;
        cell.el.innerHTML = '';
        const img = new Image();
        img.src = SPRITES.player;
        img.className = "sprite";
        cell.el.appendChild(img);

        i++;
      }, delay);
    }

    function setupClicks() {
      grid.forEach((cell, i) => {
        const { r, c } = cell;
        if (r === 0) {
          cell.el.addEventListener('click', () => run("col", c));
        } else if (c === 0) {
          cell.el.addEventListener('click', () => run("row", r));
        }
      });
    }

    createGrid();
    setupClicks();
    setInterval(spawnCoin, 700);
  </script>
</body>
</html>
